<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
<title>rangeland test</title>
<link rel="stylesheet" href="http://js.arcgis.com/3.14/esri/css/esri.css">
<style>
html, body, #map {
  height: 100%;
  width: 100%;
  margin: 0;
  padding: 0;
}
#results{
  bottom: 50px;
  right: 20px;
  width: 275px;
}
#title{
  text-align: center;
}
#myChart{
  padding-left: 10px;
}    
.mainStyle{
  position: absolute;
  z-index: 99;
  background-color: black;
  color: cornsilk;
  border-radius: 8px;
  padding: 15px;
  opacity: 0.8;
}
.pvt{
  color: #D6D00A;
}
.pub{
  color: #8A8A8A;
}
</style>

<script src="http://js.arcgis.com/3.14/"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script>
var map, landLyr, idahoCounties, pieChart, buffGeom;
require(["esri/map",
         "./Chart.js",
         "esri/graphic",
         "esri/graphicsUtils",
         "esri/config",
         "esri/geometry/Extent",
         "esri/InfoTemplate",
         "esri/geometry/geometryEngine",
         "esri/dijit/editing/Union",
         "esri/tasks/QueryTask",
         "esri/tasks/query",
         "esri/layers/ArcGISImageServiceLayer",
         "esri/tasks/ImageServiceMeasureTask",
         "esri/tasks/ImageServiceMeasureParameters",
         "esri/layers/RasterFunction",
         "esri/symbols/SimpleMarkerSymbol",
         "esri/tasks/FeatureSet",
         "esri/SpatialReference",
         "esri/symbols/SimpleFillSymbol",
         "esri/symbols/SimpleLineSymbol",
         "esri/renderers/SimpleRenderer",
         "esri/layers/ArcGISTiledMapServiceLayer",
         "esri/toolbars/draw",
         "esri/Color",
         "esri/layers/FeatureLayer",
         "dojo/on",
         "dojo/_base/array",
         "dojo/dom",
         "dojo/domReady!"
], function(Map, Chart, Graphic, graphicsUtils, ersiConfig, Extent, InfoTemplate, geometryEngine, Union, QueryTask, Query, ArcGISImageServiceLayer, ImageServiceMeasureTask, ImageServiceMeasureParameters, RasterFunction, SimpleMarkerSymbol, featureSet, SpatialReference, SimpleFillSymbol, SimpleLineSymbol, SimpleRenderer, Tiled, Draw, Color, FeatureLayer, on, array, dom) {
  src="jquery-1.12.0.min.js";

  //Set up map, layers, and properties    
  var initExtent = new Extent(-13242295.07, 5127625.01, -12141601.86, 5861420.48, new SpatialReference({wkid:3857}));
  map = new Map("map", {
    basemap: "topo",
    extent: initExtent,
  });
  map.on("load", function(){
    map.graphics.enableMouseEvents();
    map.graphics.on("click", closeHighlight);
  });

/***
 *                                                                                             
 *     ad88888ba                                        88                                     
 *    d8"     "8b                                       ""                                     
 *    Y8,                                                                                      
 *    `Y8aaaaa,     ,adPPYba,  8b,dPPYba,  8b       d8  88   ,adPPYba,   ,adPPYba,  ,adPPYba,  
 *      `"""""8b,  a8P_____88  88P'   "Y8  `8b     d8'  88  a8"     ""  a8P_____88  I8[    ""  
 *            `8b  8PP"""""""  88           `8b   d8'   88  8b          8PP"""""""   `"Y8ba,   
 *    Y8a     a8P  "8b,   ,aa  88            `8b,d8'    88  "8a,   ,aa  "8b,   ,aa  aa    ]8I  
 *     "Y88888P"    `"Ybbd8"'  88              "8"      88   `"Ybbd8"'   `"Ybbd8"'  `"YbbdP"'  
 *                                                                                             
 *                                                                                             
 */
  var landUrl = "https://gis-sandbox.northwestknowledge.net/arcgis/rest/services/idaho_rangeland_atlas/ira_2014_sma/MapServer/0";
  var rasterServer = "https://gis-sandbox.northwestknowledge.net/arcgis/rest/services/idaho_rangeland_atlas/nlcd_test/ImageServer";
  var statesUrl = "http://sampleserver6.arcgisonline.com/arcgis/rest/services/Census/MapServer/3";
  var idahoCounties = new FeatureLayer("https://gis-sandbox.northwestknowledge.net/arcgis/rest/services/idaho_rangeland_atlas/ira_2014_county_boundaries/MapServer/0", {
      mode: FeatureLayer.MODE_SNAPSHOT,
      outFields: ["Shape"] 
        });
  landLyr = new FeatureLayer(landUrl, {
    opacity: 0.9,
  });



  rasterFnc = new RasterFunction();
  filterFnc = new RasterFunction();
  rasterImgServiceLyr = new ArcGISImageServiceLayer(rasterServer, {});

  //create symbol for selected features
  symbol = new SimpleMarkerSymbol();
  symbol.setStyle(SimpleMarkerSymbol.STYLE_SQUARE);
  symbol.setSize(10);
  symbol.setColor(new Color([255,255,0,0.5]));
  //Layer symbology    
  var countySymbol = new SimpleFillSymbol(
      SimpleFillSymbol.STYLE_SOLID, 
      new SimpleLineSymbol(
        SimpleLineSymbol.STYLE_SOLID, 
        new Color([255,255,255,0.35]), 
        1
      ),
      new Color([125,125,125,0.35])
    );
   var landSymbol = new SimpleFillSymbol(
      SimpleFillSymbol.STYLE_SOLID, 
      new SimpleLineSymbol(
        SimpleLineSymbol.STYLE_SOLID, 
        new Color([255, 255, 255, 0.0]), 
        1
      ),
      new Color([253, 253, 52, 0.0])
    );

  var buffSym = new SimpleFillSymbol(SimpleFillSymbol.STYLE_NULL, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([255, 255, 255, 1]), 3), null);
  var buffSymFade = new SimpleFillSymbol(SimpleFillSymbol.STYLE_NULL, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([255, 255, 255, 0.4]), 10), null);
  var privateSym = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL, new Color([0, 0, 0]), 0), new Color([255, 0, 0, 0.69]));
  var publicSym = new SimpleFillSymbol(SimpleFillSymbol.STYLE_NULLD, new SimpleLineSymbol(SimpleLineSymbol.STYLE_NULL, new Color([0, 0, 0]), 0), new Color([255, 255, 255, 0.0]));


  idahoCounties.setRenderer(new SimpleRenderer(countySymbol));
  landLyr.setRenderer(new SimpleRenderer(landSymbol));

  map.addLayers([idahoCounties, idahoCounties]);

  //map event handlers  
 idahoCounties.on("click", function(evt){
    //initialize query task
    var selectedAgencies = GetSelected();
    map.graphics.clear();
    map.removeLayer(rasterImgServiceLyr);
    var highlightGraphic = new Graphic(evt.graphic.geometry, publicSym);
    map.graphics.add(highlightGraphic);

    GetLayers(selectedAgencies, evt);

  });
  function GetLayers(selectedLayers, evt){
    var queryTask = new QueryTask("https://gis-sandbox.northwestknowledge.net/arcgis/rest/services/idaho_rangeland_atlas/ira_2014_sma/MapServer/0");
    var queryImgTask = new QueryTask("https://gis-sandbox.northwestknowledge.net/arcgis/rest/services/idaho_rangeland_atlas/nlcd_test/ImageServer");
    var query = new Query();
    var query2 = new Query();

    var queryString = "AGNCY_NAME = '";

    query.outFields = ["AGNCY_NAME"];
    query2.outFields = [evt.graphic.geometry];
    for(i=0; i < selectedLayers.length; i++){
      if(i != selectedLayers.length - 1)
        queryString += selectedLayers[i] + "' OR AGNCY_NAME = '";
      else
        queryString += selectedLayers[i] + "'";
    }
   
    query.where = queryString;

    query.returnGeometry = true;
    query.geometry = evt.graphic.geometry;
    queryTask.on('complete', function(){console.log("");});
    queryTask.on('error', function(error){console.log(error); console.log("error with query.");});  
    queryTask.execute(query, function(result){ 
      showResults(result, evt.graphic.geometry);
      
      // rasterFnc will clip the raster to the geometry of the county.
      rasterFnc.functionName = "Clip";
      rasterFnc.variableName = "clipper";
      rasterFnc.functionArguments = {
        "ClippingGeometry" : evt.graphic.geometry,
        "ClippingType" : 1,
      };
      // filterFnc will filter out any pixel values that aren't rangeland.
      filterFnc.functionName = "Colormap";
      filterFnc.functionArguments = {
        "Colormap": [
                    [52, 0, 255, 0],
                    [71, 0, 255, 0]
                  ],
        "Raster": rasterFnc
      };
      rasterImgServiceLyr.setRenderingRule(filterFnc);
      map.addLayer(rasterImgServiceLyr);
      console.log("here");
      // Following line taken from https://developers.arcgis.com/javascript/jsapi/imageservicemeasuretask-amd.html
      imageServiceMeasureParams = new ImageServiceMeasureParameters();
      imageServiceMeasureParams.fromGeometry = evt.graphic.geometry;
      imageServiceMeasureParams.noData = 0;
      var imageMeasureTask = new ImageServiceMeasureTask("https://gis-sandbox.northwestknowledge.net/arcgis/rest/services/idaho_rangeland_atlas/nlcd_test/ImageServer",{
        imageServiceParameters: imageServiceMeasureParams,

      });
      imageMeasureTask.execute(imageServiceMeasureParams, successQ);
      console.log(rasterImgServiceLyr);
    });
  }
  function successQ(result1){
    console.log("here::");
    console.log(result1[0]);
    console.log(geometryEngine.geodesicArea(result1[0].geometry, "square-meters")/30);
    map.removeLayer(result1[0]);
  }
  function b(error){
    console.log("error: ");
    console.log(error);
  }
 function showResults(results, countyGeom) {
  buffGeom = countyGeom;
  var extent = new Extent(countyGeom);
  var resultFeatures = results.features;

  var within = geometryEngine.within(buffGeom, idahoCounties.graphics[0].geometry);
  var overlaps = geometryEngine.overlaps(buffGeom, idahoCounties.graphics[0].geometry);
  var graphic;
  var temp = new Array(resultFeatures.length);
  //Loop through each feature returned
  map.graphics.add(new Graphic(buffGeom, buffSymFade));

  dojo.forEach(resultFeatures,function(entry, i){
      if (geometryEngine.within(entry.geometry, buffGeom)) {
        map.graphics.add(entry);
        entry.setSymbol(privateSym);
      }
  });

  for (var i=0, il=resultFeatures.length; i<il; i++){
      //Get the current feature from the featureSet.
      //Feature is a graphic
      graphic = resultFeatures[i];
      temp[i] = resultFeatures[i].geometry;
      graphic.setSymbol(privateSym);
      graphic.setInfoTemplate(InfoTemplate);
  }
  graphic.setGeometry(geometryEngine.union(temp));
  graphic2 = new Graphic(graphic, privateSym);
  graphic2.setGeometry(graphic.geometry);
  graphic.setGeometry(geometryEngine.intersect(graphic2.geometry, buffGeom));

  map.graphics.add(graphic);
  createBuffer(buffGeom, graphic);

}

function createBuffer(polyGraphic, privateGraphic){
    if(buffOpt.checked){
      buffGeom = polyGraphic;
      //check if buffer is completely within Idaho
      var within = geometryEngine.within(buffGeom, idahoCounties.graphics[0].geometry);
      //check if buffer overlaps Idaho    
      var overlaps = geometryEngine.overlaps(buffGeom, idahoCounties.graphics[0].geometry);
      
      //map.graphics.add(new Graphic(buffGeom, buffSymFade));
      var privateLand = getPrivateLand(buffGeom, privateGraphic);
      var publicLand = getPublicLand(buffGeom);
      generateChart(privateLand, publicLand);   
    } else if(drawOpt.checked){
      map.graphics.clear();
    }
    else{
      return;
    }
}

function getPrivateLand(geom, privGraphic){
    var privateLandGraphics = privGraphic;
    //Only work with private land that intersects the buffer (essentially a select by location)  
    var priInBuffer = privGraphic.geometry;
    if (priInBuffer.rings.length > 0){
      //mergqe all the private land features that intersects buffer into one feature
      var privateUnion = geometryEngine.union(priInBuffer);
      //get intersection of buffer and merge (cookie cutter)
      var privateIntersect = geometryEngine.intersect(privateUnion, geom);
      return {
        geom: privateIntersect,
        area: calcArea(privateIntersect)  //get the area of the private land
      };
    }
    else{
      return {
        geom: null,
        area: 0
      };
    } 
  }

function getPublicLand(buffer, privateLand){

    if(privateLand){
      //most land that isn't private is public (city, county, state, or federally owned)     
      var publicLand = geometryEngine.difference(buffer, privateLand);
      return {
        geom: publicLand,
        area: calcArea(publicLand)
      } ;
    } else {
      return {
        geom: buffer,
        area: calcArea(buffer)
      };
    }
  }

 function ChangeSelection(agency){

  map.graphics.clear();

  landLyr = new FeatureLayer(landUrl, {
    opacity: 0.9,
    definitionExpression: "AGNCY_NAME = '" + agency + "'"
  });
  landLyr.setRenderer(new SimpleRenderer(landSymbol));
  map.addLayer(landLyr);

  switch(agency){
    case "BLM":
      document.getElementById("yllwPie").innerHTML = "BLM: ";
      break;
    case "USFS":
      document.getElementById("yllwPie").innerHTML = "USFS: ";
      break;
    case "PRIVATE":
      document.getElementById("yllwPie").innerHTML = "Selected Land: ";
  }
}
  function closeHighlight() {
    map.graphics.clear();
    map.removeLayer(rasterImgServiceLyr);
  }
  var drawPolygon = new Draw(map, { showTooltips: true });    
  

  function calcArea(geom){
    return (Math.round(geometryEngine.geodesicArea(geom, "square-miles")*100) / 100);
  }
    
  function generateChart(pvtData, pubData){
    privatePercent = Math.round((pvtData.area / pubData.area) * 100);
    publicPercent = 100 - privatePercent;
    if(!drawOpt.checked)
      map.graphics.add(new Graphic(buffGeom, buffSym));
    if(!pieChart){
      var data = [
      {
        label: "Private (sq mi)",
        value: privatePercent,
        color: "#C3BE2E",
        highlight: "#DDD534"
      },
      { 
        label: "Government (sq mi)",
        value: publicPercent,
        color: " #9C9C9C",
        highlight: "#B5B5B5" 
      }
    ];
       
    pvtPer.innerHTML = privatePercent + "%";   
    pubPer.innerHTML = publicPercent + "%";    
    }
  }

  var buffOpt = dom.byId("buffOpt");
  var drawOpt = dom.byId("drawOpt");
  var pvtPer = dom.byId("privatePer");
  var pubPer = dom.byId("publicPer");
  var baseMapChange = dom.byId("baseMap");
  var checkedAgencies = dom.byId("selectAgency");

  on(baseMapChange, "click", function(evt){
    map.setBasemap(baseMapChange.value);
  });

  function GetSelected(){
      var checkboxes = document.getElementById('selectAgency');
      var selected = [];
      for (var i=0; i<checkboxes.length; i++) {
      if (checkboxes[i].checked) {
        selected[i] = checkboxes[i].value;
      }
      }
    return selected;
  }
  on(buffOpt, "click", function(evt){
    if(buffOpt.checked){
      map.disableMapNavigation();
      drawPolygon.deactivate();
    }
  });
    
  on(drawOpt, "click", function(evt){
    if(drawOpt.checked){
      drawPolygon.activate(Draw.POLYGON);
    }
  });  
    
  on(drawPolygon, "draw-end", function(evt){  
    drawPolygon.deactivate();
    drawPolygon.activate(Draw.POLYGON);
    var geom = evt.geometry;
    if(geom.rings[0].length <= 3){
      alert("Polygon must have at least three vertices.");
      return;
    }
      
    var within = geometryEngine.within(geom, idahoCounties.graphics[0].geometry);
    //check if buffer overlaps Idaho    
    var overlaps = geometryEngine.overlaps(geom, idahoCounties.graphics[0].geometry);

    var privateLand = getPrivateLand(geom);
    var publicLand = getPublicLand(geom, privateLand.geom);
    generateChart(privateLand, publicLand);
  });  
     
  var loading = dom.byId("loadingImg");    
  function showLoading() {
    esri.show(loading);
  }

  function hideLoading(error) {
    esri.hide(loading);
  }
  hideLoading();
  on(map, "update-end", hideLoading);    
    
});
</script>
</head>

<body>
  <div id="map"><img id="loadingImg" src="http://developers.arcgis.com/javascript/samples/map_showloading/images/loading.gif" style="position:absolute; right:49%; top:49%; z-index:100;" />

    <div class="mainStyle" id="results"><h2 id="title">Idaho Land Ownership</h2>
    <br>
    <span id="yllwPie" class="pvt">Selected Land: <span id="privatePer"></span></span><br>
    <span class="pub">All Other Land: <span id="publicPer"></span></span>
    <br><br>
    <br><br><input type="radio" name="operation" id="buffOpt" checked>View ownership by county
    <br><br><input type="radio" name="operation" id="drawOpt">View ownership by polygon   
    <br><br>
    <select id="baseMap">
      <option value="topo">Topo</option>
      <option value="hybrid">Hybrid</option>
      <option value="satellite">Satellite</option>
      <option value="terrain">Terrain</option>
    </select>

    <br><br>
    <p>Agencies to display</p>
    <form id="selectAgency">
      <input type="checkbox" name="Private" value="PRIVATE">Private<br>
      <input type="checkbox" name="BLM" value="BLM">Bureau of Land Management<br>
      <input type="checkbox" name="USFS" value="USFS">U.S. Forest Service
    </form>
  </div>
</div>
</body>
</html>